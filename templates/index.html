<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disk Extractor - Movie Metadata Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/encoding.css') }}">
</head>
<body>
    <div class="header">
        <h1>Disk Extractor - Movie Metadata Manager</h1>
        <div class="header-actions">
            <a href="{{ url_for('settings') }}" class="settings-link">‚öôÔ∏è Settings</a>
            <!-- Minimal addition: connection status -->
            <div class="connection-status">
                <span id="connectionStatus" class="status-indicator offline">‚óè</span>
                <span id="connectionText">Connecting...</span>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <ul class="file-list" id="fileList">
                {% for movie in movies %}
                <li class="file-item {% if movie.has_metadata %}has-metadata{% else %}no-metadata{% endif %}" 
                    data-filename="{{ movie.file_name }}"
                    onclick="selectFile('{{ movie.file_name }}')">
                    <div class="file-name">
                        <span class="status-indicator {% if movie.has_metadata %}has-metadata{% else %}no-metadata{% endif %}"></span>
                        {{ movie.file_name }}
                    </div>
                    <div class="file-info">
                        {% if movie.size_mb %}{{ movie.size_mb }} MB{% endif %}
                        {% if movie.has_metadata %} ‚Ä¢ Has metadata{% else %} ‚Ä¢ No metadata{% endif %}
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
        
        <div class="resizer" id="resizer"></div>
        
        <div class="main-content">
            <div id="emptyState" class="empty-state">
                <h2>Select a movie file to begin</h2>
                <p>Choose a file from the list on the left to view and edit its metadata.</p>
            </div>
            
            <div id="metadataForm" style="display: none;">
                <div class="file-info-section">
                    <h2 id="currentFileName">No file selected</h2>
                    <div class="file-actions-row">
                        <div class="file-size">
                            <span id="currentFileSize"></span>
                        </div>
                        <div class="action-buttons">
                            <button type="button" id="scanButton" onclick="scanFile()" class="action-button scan-button">
                                üîç Scan Media
                            </button>
                            <button type="button" id="rawOutputButton" onclick="showRawOutput()" class="action-button raw-output-button" style="display: none;">
                                üìÑ Raw Output
                            </button>
                        </div>
                    </div>
                    
                    <!-- Queue Management Section -->
                    <div class="queue-actions" id="queueActions">
                        <!-- Queue management buttons will be populated by JavaScript -->
                    </div>
                </div>
                
                <div id="enhancedMetadata" class="enhanced-metadata">
                    <div id="scanError" class="scan-error" style="display: none;">
                        <h3>‚ö†Ô∏è HandBrake Scan Error</h3>
                        <p id="scanErrorMessage"></p>
                        <button type="button" onclick="scanFile()" class="action-button scan-button">üîÑ Retry Scan</button>
                    </div>
                    
                    <div class="titles-container" id="titlesContainer">
                        <!-- Titles will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Encoding History Section -->
                <div class="encoding-history" id="encodingHistory" style="display: none;">
                    <h4>Encoding History</h4>
                    <div id="historyContainer">
                        <!-- History items will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Raw Output Modal -->
    <div id="rawOutputModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>HandBrake Raw Output</h2>
                <span class="close" onclick="closeRawOutputModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="rawOutputContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Minimal addition: notification area -->
    <div id="notifications" class="notifications"></div>
    
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        // Initialize the app with movie data
        initializeApp({{ movies | tojson }});
    </script>
    
    <!-- WebSocket for real-time updates -->
    <script src="{{ url_for('static', filename='js/vendor/socket.io.js') }}"></script>
    <script>
        // Initialize WebSocket connection for file watching
        const socket = io();
        
        // Make socket available globally for encoding UI
        window.socket = socket;
        
        // Connection status handling
        socket.on('connect', function() {
            console.log('Connected to server');
            updateConnectionStatus(true);
            showNotification('Live file monitoring active', 'success');
            
            // Request initial encoding status
            socket.emit('request_encoding_status');
            
            // Initialize encoding UI after connection
            if (window.EncodingUI && typeof window.EncodingUI.initialize === 'function') {
                window.EncodingUI.initialize();
                console.log('Encoding UI initialized');
            }
        });
        
        socket.on('disconnect', function() {
            console.log('Disconnected from server');
            updateConnectionStatus(false);
        });
        
        // File list updates
        socket.on('file_list_update', function(data) {
            console.log('File list updated:', data.change_type, data.filename);
            updateFileList(data.movies);
            
            if (data.change_type && data.filename) {
                const messages = {
                    'added': `New movie file: ${data.filename}`,
                    'removed': `Movie file removed: ${data.filename}`,
                    'modified': `Movie file updated: ${data.filename}`,
                    'metadata_updated': `Metadata updated: ${data.filename}`
                };
                showNotification(messages[data.change_type] || 'Files updated', 'info');
            }
        });
        
        // Specific metadata updates for currently viewed movie
        socket.on('metadata_updated', function(data) {
            console.log('Metadata updated for:', data.filename);
            
            // Check if this is the currently selected/viewed movie
            if (typeof selectedFile !== 'undefined' && selectedFile === data.filename) {
                console.log('Refreshing current movie metadata');
                
                // Update the current movie data
                if (typeof currentMovies !== 'undefined') {
                    const movieIndex = currentMovies.findIndex(m => m.file_name === data.filename);
                    if (movieIndex !== -1) {
                        currentMovies[movieIndex] = data.movie_data;
                    }
                }
                
                // Refresh the metadata display for the current movie
                refreshCurrentMovieMetadata(data.movie_data);
                
                showNotification(`Metadata refreshed for ${data.filename}`, 'success');
            }
        });
        
        // Update connection status indicator
        function updateConnectionStatus(connected) {
            const statusIndicator = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');
            
            if (connected) {
                statusIndicator.className = 'status-indicator online';
                statusText.textContent = 'Live Updates';
            } else {
                statusIndicator.className = 'status-indicator offline';
                statusText.textContent = 'Disconnected';
            }
        }
        
        // Update file list with new data (minimal implementation)
        function updateFileList(movies) {
            if (typeof currentMovies !== 'undefined') {
                currentMovies = movies;
            }
            
            const fileList = document.getElementById('fileList');
            const currentSelection = document.querySelector('.file-item.selected')?.dataset.filename;
            
            // Clear and rebuild list
            fileList.innerHTML = '';
            movies.forEach(movie => {
                const li = document.createElement('li');
                li.className = `file-item ${movie.has_metadata ? 'has-metadata' : 'no-metadata'}`;
                li.dataset.filename = movie.file_name;
                li.onclick = () => selectFile(movie.file_name);
                
                if (movie.file_name === currentSelection) {
                    li.classList.add('selected');
                }
                
                li.innerHTML = `
                    <div class="file-name">
                        <span class="status-indicator ${movie.has_metadata ? 'has-metadata' : 'no-metadata'}"></span>
                        ${movie.file_name}
                    </div>
                    <div class="file-info">
                        ${movie.size_mb ? movie.size_mb + ' MB' : ''}
                        ${movie.has_metadata ? ' ‚Ä¢ Has metadata' : ' ‚Ä¢ No metadata'}
                    </div>
                `;
                fileList.appendChild(li);
            });
        }
        
        // Show notification (minimal implementation)
        function showNotification(message, type = 'info') {
            const notifications = document.getElementById('notifications');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            notifications.appendChild(notification);
            
            // Auto-remove after 4 seconds
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }
        
        // Refresh the metadata display for the currently viewed movie
        function refreshCurrentMovieMetadata(movieData) {
            try {
                // Update basic file info
                const fileNameElement = document.getElementById('currentFileName');
                const fileSizeElement = document.getElementById('currentFileSize');
                
                if (fileNameElement) {
                    fileNameElement.textContent = movieData.file_name;
                }
                
                if (fileSizeElement) {
                    fileSizeElement.textContent = movieData.size_mb ? `${movieData.size_mb} MB` : '';
                }
                
                // If there's a loadEnhancedMetadata function, call it to refresh the full metadata
                if (typeof loadEnhancedMetadata === 'function') {
                    console.log('Reloading enhanced metadata for updated file');
                    loadEnhancedMetadata(movieData.file_name);
                } else {
                    console.log('Enhanced metadata function not available, basic info updated');
                }
                
                // Update the file list item styling if metadata status changed
                const fileItem = document.querySelector(`[data-filename="${CSS.escape(movieData.file_name)}"]`);
                if (fileItem) {
                    // Update the file item classes based on metadata status
                    fileItem.className = `file-item ${movieData.has_metadata ? 'has-metadata' : 'no-metadata'}`;
                    if (fileItem.classList.contains('selected')) {
                        fileItem.classList.add('selected'); // Maintain selection
                    }
                    
                    // Update status indicator
                    const statusIndicator = fileItem.querySelector('.status-indicator');
                    if (statusIndicator) {
                        statusIndicator.className = `status-indicator ${movieData.has_metadata ? 'has-metadata' : 'no-metadata'}`;
                    }
                    
                    // Update file info text
                    const fileInfo = fileItem.querySelector('.file-info');
                    if (fileInfo) {
                        fileInfo.innerHTML = `
                            ${movieData.size_mb ? movieData.size_mb + ' MB' : ''}
                            ${movieData.has_metadata ? ' ‚Ä¢ Has metadata' : ' ‚Ä¢ No metadata'}
                        `;
                    }
                }
                
            } catch (error) {
                console.error('Error refreshing current movie metadata:', error);
            }
        }
        
        // Initialize connection status as offline
        updateConnectionStatus(false);
    </script>
    
    <!-- Encoding UI JavaScript -->
    <script src="{{ url_for('static', filename='js/encoding.js') }}"></script>
    <script>
        // Override selectFile to integrate with encoding UI
        const originalSelectFile = window.selectFile;
        window.selectFile = function(filename) {
            if (originalSelectFile) {
                originalSelectFile(filename);
            }
            
            // Update encoding UI
            if (window.EncodingUI) {
                window.EncodingUI.setSelectedFile(filename);
            }
        };
        
        // Override updateFileList to use encoding-aware version
        const originalUpdateFileList = window.updateFileList;
        window.updateFileList = function(movies) {
            // Store movies data for encoding UI
            window.moviesData = movies;
            
            // Use encoding-aware file list update
            if (window.EncodingUI) {
                window.EncodingUI.updateFileListWithEncodingStatus();
            } else {
                // Fallback to original if encoding UI not loaded
                if (originalUpdateFileList) {
                    originalUpdateFileList(movies);
                }
            }
        };
    </script>
</body>
</html>
